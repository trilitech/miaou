# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### API

- Rename `Vsection.render` parameter `~footer` to `~content_footer` to clarify it is for page content, not driver-generated keymap footers.
- Clarify `PAGE_SIG` docs: keymap footers are auto-generated by drivers, `?` is reserved but may appear in keymaps for display, and `handled_keys` is only for conflict detection.
- Add `display_only` flag to keymap bindings so reserved keys (e.g., `?`) can be shown in footers/help without being dispatched; drivers and the key handler stack respect this.
- Add `File_browser_modal` helper plus `File_browser_widget.key_hints` to avoid re-wrapping the widget for modals and to surface consistent key hints.

### Breaking Changes (2026-01-08)

#### ⚠️ PAGE_SIG Navigation API Rewrite

**Impact:** All page implementations must be updated. This is a significant API change.

**What changed:**

The `next_page` field and `enter` function have been removed from `PAGE_SIG`. Instead, pages now use the `Navigation` module for all navigation, and all handlers work with `pstate` (which wraps state in `Navigation.t`).

**Old API (removed):**
```ocaml
module type PAGE_SIG = sig
  type state
  type msg

  val init : unit -> state
  val next_page : state -> string option  (* REMOVED *)
  val enter : state -> state               (* REMOVED *)

  val update : state -> msg -> state
  val view : state -> focus:bool -> size:LTerm_geom.size -> string
  val move : state -> int -> state
  val refresh : state -> state
  val service_select : state -> int -> state
  val service_cycle : state -> int -> state
  val back : state -> state
  val keymap : state -> (string * (state -> state) * string) list
  val handled_keys : unit -> Keys.t list
  val handle_modal_key : state -> string -> size:LTerm_geom.size -> state
  val handle_key : state -> string -> size:LTerm_geom.size -> state
  val has_modal : state -> bool
end
```

**New API:**
```ocaml
module type PAGE_SIG = sig
  type state  (* Your page's own state - no next_page field needed *)
  type msg
  type pstate = state Navigation.t  (* Wrapped state with navigation *)

  val init : unit -> pstate
  val update : pstate -> msg -> pstate
  val view : pstate -> focus:bool -> size:LTerm_geom.size -> string
  val move : pstate -> int -> pstate
  val refresh : pstate -> pstate
  val service_select : pstate -> int -> pstate
  val service_cycle : pstate -> int -> pstate
  val back : pstate -> pstate
  val keymap : pstate -> (string * (pstate -> pstate) * string) list
  val handled_keys : unit -> Keys.t list
  val handle_modal_key : pstate -> string -> size:LTerm_geom.size -> pstate
  val handle_key : pstate -> string -> size:LTerm_geom.size -> pstate
  val has_modal : pstate -> bool
end
```

**Migration guide:**

1. **Remove `next_page` from your state type:**
```ocaml
(* Before *)
type state = {
  items : string list;
  cursor : int;
  next_page : string option;  (* REMOVE THIS *)
}

(* After *)
type state = {
  items : string list;
  cursor : int;
}
```

2. **Add the `pstate` type alias:**
```ocaml
type pstate = state Navigation.t
```

3. **Update `init` to wrap state:**
```ocaml
(* Before *)
let init () = { items = []; cursor = 0; next_page = None }

(* After *)
let init () = Navigation.make { items = []; cursor = 0 }
```

4. **Remove `next_page` and `enter` functions** (they no longer exist).

5. **Update all handlers to use `pstate` and Navigation functions:**
```ocaml
(* Before *)
let handle_key s key ~size =
  match key with
  | "q" -> { s with next_page = Some "__QUIT__" }
  | "Esc" -> { s with next_page = Some "__BACK__" }
  | "Enter" -> { s with next_page = Some "details" }
  | "j" -> { s with cursor = s.cursor + 1 }
  | _ -> s

(* After *)
let handle_key ps key ~size =
  match key with
  | "q" -> Navigation.quit ps
  | "Esc" -> Navigation.back ps
  | "Enter" -> Navigation.goto "details" ps
  | "j" -> Navigation.update (fun s -> { s with cursor = s.cursor + 1 }) ps
  | _ -> ps
```

6. **Update state transformations to use `Navigation.update`:**
```ocaml
(* Before *)
let refresh s = { s with items = load_items () }

(* After *)
let refresh ps = Navigation.update (fun s -> { s with items = load_items () }) ps
```

7. **Update `view` to access inner state:**
```ocaml
(* Before *)
let view s ~focus ~size = render_items s.items s.cursor

(* After *)
let view ps ~focus ~size =
  let s = ps.s in  (* Access inner state via .s field *)
  render_items s.items s.cursor
```

**Navigation module reference:**
- `Navigation.make : 'a -> 'a t` - Wrap state with no pending navigation
- `Navigation.goto : string -> 'a t -> 'a t` - Navigate to a named page
- `Navigation.back : 'a t -> 'a t` - Go back (equivalent to `goto "__BACK__"`)
- `Navigation.quit : 'a t -> 'a t` - Quit application (equivalent to `goto "__QUIT__"`)
- `Navigation.update : ('a -> 'a) -> 'a t -> 'a t` - Modify inner state
- `Navigation.pending : 'a t -> string option` - Check pending navigation (used by framework)

**Compiler errors you'll see:**
```
Error: This expression has type state but an expression was expected of type
         state Navigation.t

Error: Unbound value next_page

Error: Unbound value enter
```

**Why this change?**
- Eliminates the error-prone `next_page` field that LLM agents frequently forgot to propagate
- Clear, named navigation functions instead of magic strings in a field
- Pure functional style with no hidden side effects
- Framework handles navigation automatically - pages just call `Navigation.goto`

### Added (2026-01-08)

#### Modal Navigation Helpers

Modal `on_close` callbacks can now request navigation without using refs or checking state in `service_cycle`:

```ocaml
(* Before - error-prone pattern requiring manual ref and service_cycle check *)
let nav_ref = ref None in
Modal_manager.push
  (module My_modal)
  ~init:(My_modal.init ())
  ~ui:{ title = "Choose"; ... }
  ~commit_on:["Enter"]
  ~cancel_on:["Esc"]
  ~on_close:(fun state outcome ->
    match outcome with
    | `Commit -> nav_ref := Some "next_page"
    | `Cancel -> ()) ;

(* Then in service_cycle: *)
let service_cycle ps _ =
  match !nav_ref with
  | Some page ->
      nav_ref := None ;
      Navigation.goto page ps
  | None -> ps

(* After - direct API call *)
Modal_manager.push
  (module My_modal)
  ~init:(My_modal.init ())
  ~ui:{ title = "Choose"; ... }
  ~commit_on:["Enter"]
  ~cancel_on:["Esc"]
  ~on_close:(fun _state outcome ->
    match outcome with
    | `Commit -> Modal_manager.set_pending_navigation "next_page"
    | `Cancel -> ())

(* No service_cycle code needed - framework handles it automatically *)
```

New functions:
- `Modal_manager.set_pending_navigation : string -> unit` - Request navigation from modal callback
- `Modal_manager.take_pending_navigation : unit -> string option` - Used by framework

#### Auto-Refresh Before Service Cycle

Drivers now automatically call `Page.refresh` before `Page.service_cycle`. This means:

- Pages no longer need to manually call `refresh` in `service_cycle`
- Consistent behavior across all drivers (Matrix, Lambda-term, SDL)
- The pattern `Page.service_cycle (Page.refresh ps) 0` is now handled by the framework

```ocaml
(* Before - manual refresh in service_cycle *)
let service_cycle ps _ =
  let ps = refresh ps in  (* Manual refresh call *)
  (* ... check refs, etc. *)
  ps

(* After - just handle service logic *)
let service_cycle ps _ =
  (* refresh is already called by the driver *)
  ps
```

#### Pager Widget Enhancements

- **Wrap toggle**: Press **`w`** to toggle word wrap on/off in the pager
- **Line truncation**: Long lines are truncated with visual indicator when wrap is off
- Default behavior changed to wrap=on for better readability

#### Narrow Terminal Warning

Both Matrix and Lambda-term drivers now show consistent narrow terminal warnings:

- **Warning banner** displayed when terminal width < 80 columns
- **One-time modal** appears on first detection (auto-dismisses after 5 seconds)
- **Any key dismisses** the modal immediately
- Warning only shown once per session (not repeatedly on resize)

### Changed (2026-01-08)

#### Driver Architecture Improvements

- **Periodic partial refresh**: Matrix driver performs full buffer refresh every ~2 seconds to catch rendering artifacts
- **Region-based dirty marking**: More efficient partial updates in Matrix driver
- **Terminal cleanup reliability**: Improved cleanup on exit to restore terminal state
- **Screen content preservation**: Exit screen content saved for debugging

#### Shared Driver Modules

Common functionality extracted into shared modules:
- `terminal_raw.ml` - Raw terminal mode handling
- `input_parser.ml` - ANSI escape sequence parsing

This reduces code duplication between Matrix and Lambda-term drivers.

### Fixed (2026-01-08)

- Modal close no longer causes double-navigation with Esc key
- Matrix driver now drains pending Esc keys after modal close
- Fiber scheduling improved in Matrix driver (uses `Eio.Time.sleep`)
- File pager uses proper Eio-based fiber scheduling

### Added (2026-01-05)

#### High-Performance Matrix Terminal Driver

- **`miaou-driver-matrix`** package with Ratatui-style diff rendering
- **Two-domain architecture** using OCaml 5 Domains for true parallelism:
  - Render Domain: 60 FPS, handles diff computation and terminal output
  - Main Domain: 30 TPS, handles input and state updates
- **Cell-based double buffering** with O(1) pointer swap
- **Diff-based rendering**: only changed cells are written to terminal (no flicker)
- **Thread-safe buffer** with mutex synchronization and atomic dirty flag
- Pure ANSI output (no lambda-term dependency)
- Matrix is now the **default driver** (priority: Matrix > SDL > Lambda-term)
- Configuration via environment variables:
  - `MIAOU_DRIVER=matrix` (default) or `term` or `sdl`
  - `MIAOU_MATRIX_FPS=60` - Render domain frame rate cap
  - `MIAOU_MATRIX_TPS=30` - Main domain tick rate

#### Debug Overlay for Performance Monitoring

- **`MIAOU_OVERLAY=1`** environment variable enables real-time performance metrics
- Displays in top-right corner with dim styling:
  - **L** (Loop FPS): Render loop iteration rate (the cap)
  - **R** (Render FPS): Actual frames rendered per second
  - **T** (TPS): Ticks per second (main loop rate)
- Available in both Matrix and Lambda-term drivers
- Useful for diagnosing performance issues and verifying frame rates

### Added (2025-12-19)

#### Debounced Validation for Validated Textbox Widget

- **`debounce_ms` parameter** for `Validated_textbox_widget.create` (default: 250ms)
- Validation now defers during rapid typing, running after the debounce period elapses
- Text input remains immediate for responsive UX
- New functions:
  - `tick` - Check and run pending validation (call in `service_cycle`)
  - `flush_validation` - Force immediate validation (useful before form submission)
  - `has_pending_validation` - Check if validation is pending
- Set `debounce_ms=0` to disable debouncing (legacy immediate behavior)

#### Global Render Notification System

- **`Miaou_helpers.Render_notify`** module for widgets to request async UI updates
- `request_render()` - Request a re-render from any widget
- `should_render()` - Check if a render was requested (called by driver)
- Used by validated textbox to trigger validation after debounce period

#### Generic Debounce Module

- **`Miaou_helpers.Debounce`** module for generic debounce timing
- Thread-safe implementation using `Atomic` operations
- Functions: `create`, `mark`, `is_ready`, `clear`, `has_pending`, `check_and_clear`
- Configurable debounce period in milliseconds (default: 250ms)

#### File Browser Performance Optimization

- **Caching for directory listings** - `list_entries_with_parent` now caches results
- **Caching for writable status** - `is_writable` checks are cached per-directory
- Cache automatically invalidates when navigating to a different directory
- Cache manually invalidated after directory creation (`mkdir_and_cd`, inline mkdir)
- New `invalidate_cache()` function for manual cache clearing
- Significantly reduces filesystem calls during rapid Up/Down navigation
- **Note**: Cache is shared globally across all file browser instances

#### File Browser Hidden Files Toggle

- Press **`h`** to toggle visibility of hidden files/directories (starting with `.`)
- New `show_hidden` parameter in `open_centered` (default: `false`)
- Tab completion always includes hidden files for convenience (allows completing `.config/` etc.)
- Header hint updates dynamically to show current state

#### Textbox Input Draining for Typing Responsiveness

- **`Miaou_helpers.Input_drain`** module for draining buffered input characters
- Textbox widgets now process all pending printable characters at once
- Prevents typing lag when entering text quickly
- Driver registers drain function, widgets call `drain_pending_chars()`

### Added (2025-12-17)

- Modal sizing supports dynamic width specs (`Fixed`, `Ratio`, `Clamped`) resolved at render time, including fallback terminal size detection via `/dev/tty` so modals resize with the terminal even when `System` is mocked.

### Changed (2025-12-17)

#### Opam package restructuring for optional SDL

Restructured opam packages to allow terminal-only builds without SDL2 dependency:

- **`miaou-core`**: Standalone core package with all widgets, no SDL dependencies
- **`miaou-driver-term`**: Terminal driver, depends only on `miaou-core`
- **`miaou-driver-sdl`**: SDL driver with SDL2 dependencies (`tsdl`, `tsdl-ttf`, `tsdl-image`)
- **`miaou-widgets-display-sdl`**: SDL-specific widget implementations
- **`miaou-runner`**: Runner with `miaou-driver-sdl` as optional dependency
- **`miaou-tui`**: Meta-package for terminal-only installs (no SDL)
- **`miaou`**: Meta-package for full install (includes SDL)
- **`miaou-core.lib`**: The convenience `Miaou` module (re-exporting Core, Widgets, etc.) is now part of `miaou-core`, available to terminal-only users

Terminal-only users can now: `opam install miaou-tui`

### Breaking Changes (2025-12-17)

- Library public names changed to use package prefixes:
  - `miaou.lib` → `miaou-core.lib`
  - `miaou.core` → `miaou-core.core`
  - `miaou.widgets.display` → `miaou-core.widgets.display`
  - `miaou.driver.term` → `miaou-driver-term.driver`
  - `miaou.driver.sdl` → `miaou-driver-sdl.driver`
  - And similar for other libraries
- `Miaou_widgets_display.Sparkline_widget_sdl` moved to `Miaou_widgets_display_sdl.Sparkline_widget_sdl` (and similar for other SDL widgets)
- `Modal_manager.ui.max_width` (and related helpers) now expects `max_width_spec option` instead of `int option`; wrap existing fixed widths with `Fixed n` or switch to ratio/clamped specs.

### Changed (2025-12-15)

- File pager tail fibers are now scoped to per-page switches and auto-cancel on navigation; terminal, SDL, and headless drivers wrap pages in `Fiber_runtime.with_page_switch` for structured cleanup; `Fiber_runtime` exposes page switch helpers. Adds regression coverage for pager cleanup.
- Pager UX fixes: follow hint only shown when streaming, static pager test added, markdown renderer hides inline backticks and underlines H1 titles.
- Service lifecycle: removing instance files no longer requires a role value.
- File browser navigation: canonicalize paths so parent navigation works from relative paths, scroll the viewport earlier, and tighten Enter navigation checks; demo uses the real filesystem so Enter now changes directories.
- Modal sizing: modal pages now receive the actual modal content geometry (rows/cols) so list widgets don’t scroll into invisible items due to modal height clipping.

### Added (2025-12-11)

#### Input Buffer Draining for Navigation Keys
- **Navigation key coalescing** to prevent scroll lag in list widgets
- When arrow keys are held down and released, consecutive identical navigation events are automatically drained from the input buffer
- Only the final navigation event is processed, making the UI feel more responsive
- Debug logging available with `MIAOU_DEBUG=1` to track drain operations
- Fixes issue where selection continues scrolling for ~0.5s after releasing arrow keys

#### Braille Rendering Mode
- **Unicode Braille patterns** for high-resolution chart rendering (2×4 dots per character cell)
- Braille mode support for `Line_chart_widget`, `Bar_chart_widget`, and `Sparkline_widget`
- `Braille_canvas` module for efficient braille dot manipulation
- 8x higher resolution compared to ASCII mode with only 2x performance cost
- Colored braille output with ANSI styling support
- Performance: 9,259 renders/second for line charts in braille mode

#### Global Keys API
- **Type-safe keyboard handling system** with variant-based key definitions
- Extended `Keys.t` with new key types: `PageUp`, `PageDown`, `Home`, `End`, `Escape`, `Delete`, `Function of int`
- Global key reservations for application-wide actions: `Settings`, `Help`, `Menu`, `Quit`
- Registry validation to prevent key conflicts at page registration time
- `Registry.check_all_conflicts()` for detecting inter-page key conflicts
- `Registry.conflict_report()` for human-readable conflict summaries
- Helper functions: `Keys.is_global_key`, `Keys.get_global_action`, `Keys.show_global_keys`

### Changed (2025-12-10)

#### Performance Optimizations
- **Significant performance improvements** across all widgets (8-24x faster in some cases)
- Replaced `String.concat` with buffer-based rendering throughout codebase
- Introduced `Helpers.pad_to_width` eliminating O(n²) padding allocations
- Optimized pager widget: 9.1s → 1.2s (8x faster)
- Optimized layout widget: 9.0s → 0.8s (12x faster)
- Optimized card_sidebar: 15.1s → 1.0s (15x faster)
- All other widgets show 20-40% performance improvements

### Breaking Changes (2025-12-12)

#### ⚠️ Runtime Migrated from Lwt to Eio

**Impact:** Applications must initialize the Eio runtime before using Miaou.

**What changed:**
- All async/concurrency now uses Eio instead of Lwt
- `cohttp-lwt-unix` replaced with `cohttp-eio`
- Terminal driver uses `Eio_unix.await_readable` for input polling
- Background tasks use `Eio.Fiber` instead of `Thread.create`

**Migration guide:**

1. Wrap your main function in `Eio_main.run` and initialize the runtime:
```ocaml
(* Before *)
let () =
  let page = ... in
  Miaou_runner_tui.Runner_tui.run page

(* After *)
let () =
  Eio_main.run @@ fun env ->
  Eio.Switch.run @@ fun sw ->
  Miaou_helpers.Fiber_runtime.init ~env ~sw;
  let page = ... in
  Miaou_runner_tui.Runner_tui.run page
```

2. Update opam dependencies:
```
- lwt
- cohttp-lwt-unix
+ eio
+ eio_main
+ cohttp-eio
```

**New modules:**
- `Miaou_helpers.Fiber_runtime` — shared Eio runtime management
- `Miaou_widgets_display.File_pager` — Eio-based file tailing pager

#### ⚠️ Pager Widget: Notification Callback Now Per-Instance

**Impact:** Code using `Pager_widget.set_notify_render` must be updated.

**What changed:**
```ocaml
(* OLD - Global callback (removed) *)
Pager_widget.set_notify_render (Some callback);
let pager = Pager_widget.open_lines ~title:"Log" lines in

(* NEW - Per-instance callback *)
let pager = Pager_widget.open_lines ~title:"Log" ~notify_render:callback lines in
```

**Migration guide:**

1. Remove calls to `set_notify_render`
2. Pass `~notify_render` parameter to `open_lines`/`open_text`

**Before:**
```ocaml
let pager = Pager_widget.open_lines ~title:"My Pager" [] in
Pager_widget.set_notify_render (Some render_callback);
```

**After:**
```ocaml
let pager = Pager_widget.open_lines ~title:"My Pager"
              ~notify_render:render_callback [] in
```

**Why this change?**
- Eliminates global mutable state
- Enables multiple independent pagers with different callbacks
- Makes callback lifetime explicit (tied to pager instance)
- Better composability and testability

**Type signature changes:**
- `open_lines : ?title:string -> ?notify_render:(unit -> unit) -> string list -> t`
- `open_text : ?title:string -> ?notify_render:(unit -> unit) -> string -> t`
- `set_notify_render` function removed

**Compiler error you'll see:**
```
Error: Unbound value Pager_widget.set_notify_render
```

### Breaking Changes (2025-12-11)

#### ⚠️ PAGE_SIG Requires `handled_keys` Function

**Impact:** All page implementations must be updated.

**What changed:**
```ocaml
module type PAGE_SIG = sig
  (* ... existing fields ... *)
  
  (* NEW - REQUIRED *)
  val handled_keys : unit -> Keys.t list
end
```

**Migration guide:**

For **minimal migration**, add this to every page:
```ocaml
let handled_keys () = []
```

For **proper key declaration** (recommended):
```ocaml
let handled_keys () = [
  Keys.Char "a";      (* Declare all keys your page handles *)
  Keys.Enter;
  Keys.Up;
  Keys.Down;
  (* ... *)
]
```

**Why this change?**
- Enables compile-time key conflict detection
- Self-documents key bindings
- Foundation for auto-generated help system
- Enables future page registry and navigation features

**Compiler error you'll see:**
```
Error: Signature mismatch:
       The value `handled_keys' is required but not provided
       File "src/miaou_core/tui_page.mli", line 38, characters 2-40:
         Expected declaration
```

**Benefits:**
- ✅ Type-safe key handling (variants, not strings)
- ✅ Prevents global key conflicts automatically
- ✅ Runtime validation catches inter-page conflicts
- ✅ Clear error messages when conflicts occur

## [Previous Releases]

<!-- Previous changelog entries would go here -->
